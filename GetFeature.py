

import os
import sys
import GetConfig
from MLlib.Preprocessing.change_file_to_image import *
from MLlib.Preprocessing.Get_GLCM_from_image import *
from MLlib.Preprocessing import Get_GLCM_Feature
import numpy as np



MalwareAnalysisConf=GetConfig.GetConf().confJson

'''
Get GLCM Feature from sample
'''
class OneSampleglcmFeature(object):
    def __init__(self,filepath,file_o=None):
        self.filepath=filepath
        self.Image_put=file_o
        
    def GetGLCMFearure(self):
        UseGLCMMode=MalwareAnalysisConf["FeatureSet"]["glcm_feature"][1:-1].split(',')
        self._Gimage=getMatrix_from_bin(self.filepath,file_o=self.Image_put).get_bin_from_file()
        self._GLCM=GetGLCM(self._Gimage,InitGrayZeroMatix())
        self._GLCM.GetGrayCoocurrenceMatrix(GLCM_distence=int(MalwareAnalysisConf["GLCM_arg"]["glcm_distance"]),choice_distences=int(MalwareAnalysisConf["GLCM_arg"]["choice_distences"]))
        Feature_data=[]
        for _ in UseGLCMMode:
            Feature_data.append(getattr(Get_GLCM_Feature,str(_))(self._GLCM.grayzeroMatrix,self._GLCM.ChangeCount))
        return Feature_data

def AllsampleglcmFeature():
    malwarepath=MalwareAnalysisConf["MalwareFilePath"]["malwarefp"]
    UseGLCMMode=MalwareAnalysisConf["FeatureSet"]["glcm_feature"][1:-1].split(',')
    if not os.path.isdir(malwarepath):
        raise ValueError("We can't find this file,please check anagin!!")
    FamilesList=os.listdir(malwarepath)
    AllFeatureInfo={}
    for _ in FamilesList:
        AllFeatureInfo.update({_:{}})
    for _ in FamilesList:
        templist=[]
        OneFSamplepath=os.path.join(malwarepath,_)
        for i in os.listdir(OneFSamplepath):
            templist.append(OneSampleglcmFeature(os.path.join(OneFSamplepath,i)))
        AllFeatureInfo.update({_:dict(zip(UseGLCMMode,np.transpose(templist)))})
        #这里将GLCM特征与特征值进行规整匹配
        
class OneSamplengrmFeature(object):
    def __init__(self,sCodePath):
        self.sCodePath=sCodePath


if __name__ == "__main__":
    s=OneSampleglcmFeature("D:/work/sample_analysis/20171130/20171130/a6/config_20171127082139.exe")
    print s.GetGLCMFearure()
    # AllsampleglcmFeature()
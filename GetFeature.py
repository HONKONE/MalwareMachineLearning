import os
import sys
import GetConfig
from MLlib.Preprocessing.change_file_to_image import *
from MLlib.Preprocessing.Get_GLCM_from_image import *
from MLlib.Preprocessing import Get_GLCM_Feature
import numpy as np



MalwareAnalysisConf=GetConfig.GetConf().confJson

'''
Get Feature from sample
'''
class OneSampleFeature(object):
    def __init__(self,filepath,file_o=None):
        self.GLCM_Feature=None
        self.Ngram_Feature=None
        self.filepath=filepath
        self.Image_put=file_o
        
    def GetGLCMFearure(self):
        UseGLCMMode=MalwareAnalysisConf["FeatureSet"]["glcm_feature"][1:-1].split(',')
        self._Gimage=getMatrix_from_bin(self.filepath,file_o=self.Image_put).get_bin_from_file()
        self._GLCM=GetGLCM(self._Gimage,InitGrayZeroMatix())
        self._GLCM.GetGrayCoocurrenceMatrix(GLCM_distence=int(MalwareAnalysisConf["GLCM_arg"]["glcm_distance"]),choice_distences=int(MalwareAnalysisConf["GLCM_arg"]["choice_distences"]))
        Feature_data=[]
        for _ in UseGLCMMode:
            Feature_data.append(getattr(Get_GLCM_Feature,str(_))(self._GLCM.grayzeroMatrix,self._GLCM.ChangeCount))
        return Feature_data

def AllsampleFeature():
    malwarepath=MalwareAnalysisConf["MalwareFilePath"]["malwarefp"]
    UseGLCMMode=MalwareAnalysisConf["FeatureSet"]["glcm_feature"][1:-1].split(',')
    if not os.path.isdir(malwarepath):
        raise ValueError("We can't find this file,please check anagin!!")
    FamilesList=os.listdir(malwarepath)
    AllFeatureInfo={}
    for _ in FamilesList:
        AllFeatureInfo.update({_:{}})
    for _ in FamilesList:
        templist=[]
        OneFSamplepath=os.path.join(malwarepath,_)
        for i in os.listdir(OneFSamplepath):
            templist.append(OneSampleFeature(os.path.join(OneFSamplepath,i)))
        AllFeatureInfo.update({_:dict(zip(UseGLCMMode,templist))})
        
            



if __name__ == "__main__":
    # s=OneSampleFeature("D:/work/sample_analysis/20171130/20171130/a6/config_20171127082139.exe")
    # print s.GetGLCMFearure()
    # AllsampleFeature()
    a=[
        [1,2,3,4],
        [2,3,4,5],
        [3,4,5,6]
    ]
    d=["dd","ff","bb","rr"]
    s=np.transpose(a)
    pp=dict(zip(d,s))
    print pp
    print pp['dd']